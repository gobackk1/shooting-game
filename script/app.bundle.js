!function(t){var e={};function s(i){if(e[i])return e[i].exports;var h=e[i]={i:i,l:!1,exports:{}};return t[i].call(h.exports,h,h.exports,s),h.l=!0,h.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)s.d(i,h,function(e){return t[e]}.bind(null,h));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){this.canvasElement=t,this.ctx=t.getContext("2d")}get canvas(){return this.canvasElement}get context(){return this.ctx}drawRect(t,e,s,i,h){null!=h&&(this.ctx.fillStyle=h),this.ctx.fillRect(t,e,s,i)}drawLine(t,e,s,i,h,r=1){null!=h&&(this.ctx.strokeStyle=h),this.ctx.lineLength=r,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(s,i),this.ctx.closePath(),this.ctx.stroke()}drawPolygon(t,e){if(!(!0!==Array.isArray(t)||t.length<6)){null!=e&&(this.ctx.fillStyle=e),this.ctx.beginPath(),this.ctx.moveTo(t[0],t[1]);for(let e=2;e<t.length;e+=2)this.ctx.lineTo(t[e],t[e+1]);this.ctx.closePath(),this.ctx.fill()}}drawCircle(t,e,s,i){null!=i&&(this.ctx.fillStyle=i),this.ctx.beginPath(),this.ctx.arc(t,e,s,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}drawFan(t,e,s,i,h,r){null!=r&&(this.ctx.fillStyle=r),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.arc(t,e,s,i,h),this.ctx.closePath(),this.ctx.fill()}drawQuadraticBezier(t,e,s,i,h,r,a,o=1){null!=a&&(this.ctx.fillStyle=a),this.ctx.lineLength=o,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.quadraticCurveTo(h,r,s,i),this.ctx.closePath(),this.ctx.stroke()}drawCubicBezier(t,e,s,i,h,r,a,o,n,l=1){null!=n&&(this.ctx.fillStyle=n),this.ctx.lineLength=l,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.bezierCurveTo(h,r,a,o,s,i),this.ctx.closePath(),this.ctx.stroke()}drawText(t,e,s,i,h){null!=i&&(this.ctx.fillStyle=i),this.ctx.fillText(t,e,s,h)}imageLoader(t){return new Promise(e=>{let s=new Image;s.addEventListener("load",()=>{e(s)}),s.src=t})}}var h={isKeyDown:{},gameScore:0};class r{constructor(t,e){this.x=null,this.y=null,this.set(t,e)}set(t,e){null!=t&&(this.x=t),null!=e&&(this.y=e)}distance(t){let e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}cross(t){return this.x*t.y-this.y*t.x}normalize(){let t=Math.sqrt(this.x*this.x+this.y*this.y);if(0===t)return new r(0,0);let e=this.x/t,s=this.y/t;return new r(e,s)}rotate(t){let e=Math.sin(t),s=Math.cos(t);this.x=this.x*s+this.y*-e,this.y=this.x*e+this.y*s}static calcLength(t,e){return Math.sqrt(t*t+e*e)}static calcNormal(t,e){let s=r.calcLength(t,e);return new r(t/s,e/s)}}class a{constructor(t,e,s,i,h,a,o){this.ctx=t,this.pos=new r(e,s),this.width=i,this.height=h,this.life=a,this.image=new Image,console.log(this.image),this.image.addEventListener("load",()=>{console.log("imageLoaded"),this.ready=!0}),this.image.src=o,this.ready=!1,this.vector=new r(0,-1),this.angle=270*Math.PI/180}setVector(t,e){this.vector.set(t,e)}setVectorFromAngle(t){this.angle=t;let e=Math.sin(t),s=Math.cos(t);this.vector.set(s,e)}rotationDraw(){this.ctx.save(),this.ctx.translate(this.pos.x,this.pos.y),this.ctx.rotate(this.angle-1.5*Math.PI);let t=this.width/2,e=this.height/2;this.ctx.drawImage(this.image,-t,-e,this.width,this.height),this.ctx.restore()}draw(){let t=this.width/2,e=this.height/2;this.ctx.drawImage(this.image,this.pos.x-t,this.pos.y-e,this.width,this.height)}}class o extends a{constructor(t,e,s,i,h,r){super(t,e,s,i,h,1,r),this.isComing=!1,this.comingStart=null,this.comingStartPos=null,this.comingEndPos=null,this.speed=4,this.shotArray=null,this.singleShotArray=null,this.shotCheckCounter=0,this.shotInterval=10}setComing(t,e,s,i){this.isComing=!0,this.life=1,this.comingStart=Date.now(),this.pos.set(t,e),this.comingStartPos=new r(t,e),this.comingEndPos=new r(s,i)}setShotArray(t,e){this.shotArray=t,this.singleShotArray=e}update(){if(this.life<=0)return;let t=Date.now();if(!0===this.isComing){let e=(t-this.comingStart)/1e3,s=this.comingStartPos.y-50*e;s<=this.comingEndPos.y&&(this.isComing=!1,s=this.comingEndPos.y),this.pos.set(this.pos.x,s),t%100<50&&(this.ctx.globalAlpha=.5)}else{!0===h.isKeyDown.key_ArrowLeft&&(this.pos.x-=this.speed),!0===h.isKeyDown.key_ArrowRight&&(this.pos.x+=this.speed),!0===h.isKeyDown.key_ArrowUp&&(this.pos.y-=this.speed),!0===h.isKeyDown.key_ArrowDown&&(this.pos.y+=this.speed);let t=this.ctx.canvas.width,e=this.ctx.canvas.height,s=Math.min(Math.max(this.pos.x,0),t),i=Math.min(Math.max(this.pos.y,0),e);if(this.pos.set(s,i),!0===h.isKeyDown.key_z&&this.shotCheckCounter>=0){for(let t=0;t<this.shotArray.length;t++)if(this.shotArray[t].life<=0){this.shotArray[t].set(this.pos.x,this.pos.y),this.shotCheckCounter=-this.shotInterval;break}for(let t=0;t<this.singleShotArray.length;t+=2)if(this.singleShotArray[t].life<=0&&this.singleShotArray[t+1].life<=0){let e=265*Math.PI/180,s=275*Math.PI/180;this.singleShotArray[t].set(this.pos.x-20,this.pos.y),this.singleShotArray[t].setVectorFromAngle(e),this.singleShotArray[t+1].set(this.pos.x+20,this.pos.y),this.singleShotArray[t+1].setVectorFromAngle(s),this.shotCheckCounter=-this.shotInterval;break}}++this.shotCheckCounter}this.draw(),this.ctx.globalAlpha=1}}function n(t){return t*Math.PI/180}class l extends a{constructor(t,e,s,i,h,r){super(t,e,s,i,h,0,r),this.speed=3,this.shotArray=null,this.type="default",this.frame=0,this.attackTarget=null}set(t,e,s=1,i="default"){this.pos.set(t,e),this.life=s,this.type=i,this.frame=0}setShotArray(t){this.shotArray=t}setAttackTarget(t){this.attackTarget=t}fire(t=0,e=1,s=5){for(let i=0;i<this.shotArray.length;i++)if(this.shotArray[i].life<=0){this.shotArray[i].set(this.pos.x,this.pos.y),this.shotArray[i].setSpeed(s),this.shotArray[i].setVector(t,e);break}}update(){if(!(this.life<=0)){switch(this.type){case"wave":if(this.frame%60==0){let t=this.attackTarget.pos.x-this.pos.x,e=this.attackTarget.pos.y-this.pos.y,s=r.calcNormal(t,e);this.fire(s.x,s.y,4)}this.pos.x+=Math.sin(this.frame/10),this.pos.y+=2,this.pos.y-this.height>this.ctx.canvas.height&&(this.life=0);break;case"large":if(this.frame%50==0)for(let t=0;t<360;t+=45){let e=t*Math.PI/180,s=Math.sin(e),i=Math.cos(e);this.fire(i,s,2.5)}this.pos.x+=2*Math.sin((this.frame+90)/50),this.pos.y+=1,this.pos.y-this.height>this.ctx.canvas.height&&(this.life=0);break;case"default":default:50===this.frame&&this.fire(),this.pos.x+=this.vector.x*this.speed,this.pos.y+=this.vector.y*this.speed,this.pos.y-this.height>this.ctx.canvas.height&&(this.life=0)}this.draw(),++this.frame}}}class c extends a{constructor(t,e,s,i,h,r){super(t,e,s,i,h,0,r),this.speed=3,this.shotArray=null,this.homingArray=null,this.attackTarget=null,this.mode="",this.frame=0}set(t,e,s=1){this.pos.set(t,e),this.life=s,this.frame=0}setSpeed(t){this.speed=t}setMode(t){this.mode=t}setShotArray(t){this.shotArray=t}setHomingArray(t){this.homingArray=t}setAttackTarget(t){this.attackTarget=t}fire(t=0,e=1,s=5){for(let i=0;i<this.shotArray.length;i++)if(this.shotArray[i].life<=0){this.shotArray[i].set(this.pos.x,this.pos.y),this.shotArray[i].setSpeed(s),this.shotArray[i].setVector(t,e);break}}homingFire(t=0,e=1,s=3){for(let i=0;i<this.homingArray.length;i++)if(this.homingArray[i].life<=0){this.homingArray[i].set(this.pos.x,this.pos.y),this.homingArray[i].setSpeed(s),this.homingArray[i].setVector(t,e);break}}update(){if(!(this.life<=0)){switch(this.mode){case"invade":this.pos.y+=this.speed,this.pos.y>100&&(this.pos.y=100,this.mode="floating",this.frame=0);break;case"escape":this.pos.y-=this.speed,this.pos.y<-this.height&&(this.life=0);break;case"floating":if(this.frame%1e3<500){if(this.frame%200>140&&this.frame%8==0){let t=this.attackTarget.pos.x-this.pos.x,e=this.attackTarget.pos.y-this.pos.y,s=r.calcNormal(t,e);this.fire(s.x,s.y,4.7),this.fire(s.x-.15,s.y,4),this.fire(s.x+.15,s.y,4)}}else if(this.frame%80==0){let t=this.attackTarget.pos.x-this.pos.x,e=this.attackTarget.pos.y-this.pos.y,s=r.calcNormal(t,e);this.homingFire(s.x,s.y,3)}this.pos.x+=2*Math.cos(this.frame/100)}this.draw(),++this.frame}}}class p extends a{constructor(t,e,s,i,h,r){super(t,e,s,i,h,0,r),this.speed=7,this.power=1,this.targetArray=[],this.explosionArray=[]}set(t,e,s,i){this.pos.set(t,e),this.life=1,this.setSpeed(s),this.setPower(i)}setSpeed(t){null!=t&&t>0&&(this.speed=t)}setPower(t){null!=t&&t>0&&(this.power=t)}setTargetArray(t){Array.isArray(t)&&null!=t&&t.length>0&&(this.targetArray=t)}setExplosionArray(t){Array.isArray(t)&&null!=t&&t.length>0&&(this.explosionArray=t)}update(){this.life<=0||((this.pos.y+this.height<0||this.pos.y-this.height>this.ctx.canvas.height||this.pos.x+this.width<0||this.pos.x-this.width>this.ctx.canvas.width)&&(this.life=0),this.pos.x+=this.vector.x*this.speed,this.pos.y+=this.vector.y*this.speed,this.targetArray.map(t=>{if(this.life<=0||t.life<=0)return;if(this.pos.distance(t.pos)<=(this.width+t.width)/4){if(t instanceof o==!0&&!0===t.isComing)return;if(t.life-=this.power,t.life<=0){for(let e=0;e<this.explosionArray.length;e++)if(!0!==this.explosionArray[e].life){this.explosionArray[e].set(t.pos.x,t.pos.y);break}if(t instanceof l==!0){let e=100;"large"===t.type&&(e=1e3),h.gameScore=Math.min(h.gameScore+e,99999)}else t instanceof c==!0&&(h.gameScore=Math.min(h.gameScore+15e3,99999))}this.life=0}}),this.rotationDraw())}}class f{constructor(t,e,s,i,h,r="#ff1166"){this.ctx=t,this.life=!1,this.color=r,this.sound=null,this.pos=null,this.radius=e,this.count=s,this.startTime=0,this.timeRange=h,this.fireBaseSize=i,this.fireSize=[],this.firePos=[],this.fireVector=[]}set(t,e){for(let s=0;s<this.count;s++){this.firePos[s]=new r(t,e);let i=Math.random()*Math.PI*2,h=Math.sin(i),a=Math.cos(i),o=Math.random();this.fireVector[s]=new r(a*o,h*o),this.fireSize[s]=(.5*Math.random()+.5)*this.fireBaseSize}this.life=!0,this.startTime=Date.now(),null!=this.sound&&this.sound.play()}setSound(t){this.sound=t}update(){if(!0!==this.life)return;this.ctx.fillStyle=this.color,this.ctx.globalAlpha=.5;let t=(Date.now()-this.startTime)/1e3;var e;let s=1-(e=1-Math.min(t/this.timeRange,1))*e*e*e;for(let t=0;t<this.firePos.length;t++){let e=this.radius*s,i=this.firePos[t].x+this.fireVector[t].x*e,h=this.firePos[t].y+this.fireVector[t].y*e,r=1-s;this.ctx.fillRect(i-this.fireSize[t]*r/2,h-this.fireSize[t]*r/2,this.fireSize[t]*r,this.fireSize[t]*r)}this.ctx.globalAlpha=1,s>=1&&(this.life=!1)}}class d{constructor(){this.scene={},this.activeScene=null,this.startTime=null,this.frame=null}add(t,e){this.scene[t]=e}use(t){!0===this.scene.hasOwnProperty(t)&&(this.activeScene=this.scene[t],this.startTime=Date.now(),this.frame=-1)}update(){let t=(Date.now()-this.startTime)/1e3;this.activeScene(t),++this.frame}}class u{constructor(){this.ctx=new AudioContext,this.source=null}async load(t){let e=await fetch(t),s=await e.arrayBuffer(),i=await this.ctx.decodeAudioData(s);if(null==i)throw new Error("sound読み込みエラー");this.source=i}play(){let t=new AudioBufferSourceNode(this.ctx,{buffer:this.source});t.connect(this.ctx.destination),t.addEventListener("ended",()=>{t.stop(),t.disconnect(),t=null}),t.start()}}class y{constructor(t,e,s,i="#ffffff"){this.ctx=t,this.color=i,this.pos=null,this.size=e,this.speed=s}set(t,e){this.pos=new r(t,e)}update(){this.ctx.fillStyle=this.color,this.pos.y+=this.speed,this.ctx.fillRect(this.pos.x-this.size/2,this.pos.y-this.size/2,this.size,this.size),this.pos.y+this.size>this.ctx.canvas.height&&(this.pos.y=-this.size)}}class g extends p{constructor(t,e,s,i,h,r){super(t,e,s,i,h,r),this.frame=0}set(t,e,s,i){this.pos.set(t,e),this.life=1,this.setSpeed(s),this.setPower(i),this.frame=0}update(){if(this.life<=0)return;(this.pos.x+this.width<0||this.pos.x-this.width>this.ctx.canvas.width||this.pos.y+this.height<0||this.pos.y-this.height>this.ctx.canvas.height)&&(this.life=0);let t=this.targetArray[0];if(this.frame<300){let e=new r(t.pos.x-this.pos.x,t.pos.y-this.pos.y).normalize();this.vector=this.vector.normalize();let s=this.vector.cross(e),i=Math.PI/120;s>0?this.vector.rotate(i):s<0&&this.vector.rotate(-i)}this.pos.x+=this.vector.x*this.speed,this.pos.y+=this.vector.y*this.speed,this.angle=Math.atan2(this.vector.y,this.vector.x),this.targetArray.map(t=>{if(this.life<=0||t.life<=0)return;if(this.pos.distance(t.pos)<=(this.width+t.width)/4){if(t instanceof o==!0&&!0===t.isComing)return;if(t.life-=this.power,t.life<=0){for(let e=0;e<this.explosionArray.length;e++)if(!0!==this.explosionArray[e].life){this.explosionArray[e].set(t.pos.x,t.pos.y);break}if(t instanceof l==!0){let e=100;"large"===t.type&&(e=1e3),h.gameScore=Math.min(h.gameScore+e,99999)}}this.life=0}}),this.rotationDraw(),++this.frame}}window.AudioContext=window.AudioContext||window.webkitAudioContext,console.log(window.AudioContext),console.log(window.fetch);let m=null,x=null,w=null,v=null,A=[],k=[],S=[],b=[],M=[],_=[],P=[],T=null,C=null,E=null,z=null,D=!1,L=!1;function j(){let t=!0;t=t&&T.ready,t=t&&z.ready,A.map(e=>t=t&&e.ready),k.map(e=>t=t&&e.ready),S.map(e=>t=t&&e.ready),b.map(e=>t=t&&e.ready),!0===t?(window.addEventListener("keydown",t=>{h.isKeyDown[`key_${t.key}`]=!0,"Enter"===t.key&&T.life<=0&&(D=!0)}),window.addEventListener("keyup",t=>{h.isKeyDown[`key_${t.key}`]=!1}),C.add("intro",t=>{t>2&&C.use("invade_default_type")}),C.add("invade_default_type",t=>{if(C.frame%30==0)for(let t=0;t<20;t++)if(S[t].life<=0){let e=S[t];C.frame%60==0?(e.set(-e.width,30,2,"default"),e.setVectorFromAngle(n(30))):(e.set(600+e.width,30,2,"default"),e.setVectorFromAngle(n(150)));break}270===C.frame&&C.use("blank"),T.life<=0&&C.use("gameover")}),C.add("blank",t=>{150===C.frame&&C.use("invade_wave_move_type"),T.life<=0&&C.use("gameover")}),C.add("invade_wave_move_type",t=>{if(C.frame%50==0)for(let t=0;t<20;t++)if(S[t].life<=0){let e=S[t],s=.1+.8*Math.random();e.set(600*s,-e.height,2,"wave");break}450===C.frame&&C.use("invade_large_type"),T.life<=0&&C.use("gameover")}),C.add("invade_large_type",t=>{if(100===C.frame){let t=25;for(let e=20;e<t;e++)if(S[e].life<=0){let t=S[e];t.set(200,-t.height,40,"large");break}}if(200===C.frame){let t=25;for(let e=20;e<t;e++)if(S[e].life<=0){let t=S[e];t.set(400,-t.height,40,"large");break}}800===C.frame&&C.use("invade_boss"),T.life<=0&&C.use("gameover")}),C.add("invade_boss",t=>{0===C.frame&&(z.set(300,-z.height,250),z.setMode("invade")),T.life<=0&&(C.use("gameover"),z.setMode("escape")),z.life<=0&&C.use("intro")}),C.add("gameover",t=>{let e=600-2*C.frame%900;w.font="bold 72px sans-serif",m.drawText("GAME OVER",e,350,"#ff0000",300),!0===D&&(D=!1,h.gameScore=0,T.setComing(300,750,300,600),C.use("intro"))}),C.use("intro"),v=Date.now(),I()):setTimeout(j,100)}function I(){var t,e;w.globalAlpha=1,m.drawRect(0,0,x.width,x.height,"#111122"),w.font="bold 24px monospace",m.drawText((t=h.gameScore,e=5,(new Array(e).join("0")+t).slice(-e)),30,50,"#ffffff");Date.now();C.update(),T.update(),z.update(),A.map(t=>t.update()),k.map(t=>t.update()),S.map(t=>t.update()),b.map(t=>t.update()),M.map(t=>t.update()),_.map(t=>t.update()),P.map(t=>t.update()),requestAnimationFrame(I)}window.addEventListener("load",()=>{m=new i(document.querySelector("#canvas")),x=m.canvas,w=m.context,x.width=600,x.height=700;let t=document.querySelector("#btn-start"),e=document.querySelector("#btn-bgm"),s=document.querySelector("#bgm");t.addEventListener("click",async()=>{t.disabled=!0,E=new u,await E.load("https://kksample.sakura.ne.jp/invader/sound/small_explosion1.mp3"),function(){let t;for(T=new o(w,0,0,64,64,"https://kksample.sakura.ne.jp/invader/image/viper_2.png"),T.setComing(300,700,300,600),C=new d,t=0;t<10;t++)M[t]=new f(w,100,15,40,1),M[t].setSound(E);for(t=0;t<10;t++)A[t]=new p(w,0,0,32,32,"https://kksample.sakura.ne.jp/invader/image/viper_shot_normal_2.png"),A[t].setSpeed(8.5),k[2*t]=new p(w,0,0,32,32,"https://kksample.sakura.ne.jp/invader/image/viper_shot_normal_2.png"),k[2*t].setSpeed(8),k[2*t+1]=new p(w,0,0,32,32,"https://kksample.sakura.ne.jp/invader/image/viper_shot_normal_2.png"),k[2*t+1].setSpeed(8);for(t=0;t<50;t++)b[t]=new p(w,0,0,24,24,"https://kksample.sakura.ne.jp/invader/image/enemy_shot_1.png"),b[t].setTargetArray([T]),b[t].setExplosionArray(M);for(t=0;t<50;t++)P[t]=new g(w,0,0,32,32,"https://kksample.sakura.ne.jp/invader/image/enemy_homing_shot.png"),P[t].setTargetArray([T]),P[t].setExplosionArray(M);for(z=new c(w,0,0,128,128,"https://kksample.sakura.ne.jp/invader/image/boss_1.png"),z.setShotArray(b),z.setHomingArray(P),z.setAttackTarget(T),t=0;t<20;t++)S[t]=new l(w,0,0,48,48,"https://kksample.sakura.ne.jp/invader/image/enemy_small_1.png"),S[t].setShotArray(b),S[t].setAttackTarget(T);for(t=0;t<5;t++)S[20+t]=new l(w,0,0,64,64,"https://kksample.sakura.ne.jp/invader/image/enemy_large_1.png"),S[20+t].setShotArray(b),S[20+t].setAttackTarget(T);let e=S.concat([z]);for(t=0;t<10;t++)A[t].setTargetArray(e),k[2*t].setTargetArray(e),k[2*t+1].setTargetArray(e),A[t].setExplosionArray(M),k[2*t].setExplosionArray(M),k[2*t+1].setExplosionArray(M);for(t=0;t<100;t++){let e=1+2*Math.random(),s=1+3*Math.random();_[t]=new y(w,e,s);let i=600*Math.random(),h=700*Math.random();_[t].set(i,h)}T.setShotArray(A,k)}(),j()}),e.addEventListener("click",()=>{L?s.paused?(s.play(),e.value="BGMを停止する"):(s.pause(),e.value="BGMを再生する"):(s.addEventListener("canplaythrough",(function t(){s.play(),e.disabled=!1,e.value="BGMを停止する",L=!0,s.removeEventListener("canplaythrough",t)})),s.src=s.dataset.src,e.disabled=!0,e.value="BGM読み込み中")})})}]);